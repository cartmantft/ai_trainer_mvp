# AI 스쿼트 트레이너 MVP 개발 요약 (최종 업데이트: 2025-03-28)

## 1. 프로젝트 목표 및 초기 구상

*   **목표:** AI를 활용하여 집에서 쉽게 운동할 수 있는 앱 개발.
*   **MVP 범위:** 웹캠을 이용한 **측면 스쿼트** 영상 실시간 분석 및 **잘못된 자세**에 대한 피드백 제공.
*   **선정된 기술:** Python, OpenCV, **MediaPipe Pose** (실시간 자세 추정).

## 2. 분석 대상 오류 및 감지 전략 정의 (측면 뷰 기준)

*   **주요 오류 정의:**
    1.  **불충분한 깊이 (Insufficient Depth):** 엉덩이가 무릎 높이까지 충분히 내려가지 않음.
    2.  **과도한 상체 숙임 (Excessive Forward Lean):** 상체가 앞으로 너무 많이 기울어짐.
    3.  **발뒤꿈치 들림 (Heels Lifting):** 스쿼트 중 발뒤꿈치가 바닥에서 뜸.
*   **감지 전략:** MediaPipe Pose 랜드마크 좌표(주로 어깨, 엉덩이, 무릎, 발목, 발뒤꿈치)를 이용하여 관절 각도 및 상대적 위치를 계산하고, 임계값과 비교하여 오류 판단.

## 3. 코드 개발 및 반복 개선 과정

*   **[v1 - 초기 코드 @ GitHub]:** 기본 구조 구현 (MediaPipe 연동, 각도 계산, 상태 구분 시도).
    *   **문제점:** 피드백 로직 모호, 주요 오류 감지 누락, 임계값 하드코딩, 특정 측면(왼쪽) 가정.
*   **[v2 - 자동 측면 감지 시도 1 (가시성 차이)]:** 양쪽 어깨의 `visibility` 값 차이를 이용해 좌우 측면 자동 감지 로직 추가.
    *   **문제점:** 실제 테스트 결과, 측면 자세에서도 양쪽 어깨 가시성 차이가 매우 작아(`ActualDiff` ≈ 0.004) 설정된 임계값(`Threshold`=0.2 또는 0.1)을 넘지 못해 측면 감지 실패.
    *   **부가 작업:** 디버깅 위한 로깅 기능 추가 (`logging` 모듈), 로그 한글 깨짐 문제 해결 (`utf-8` 인코딩 지정).
*   **[v3 - 자동 측면 감지 시도 2 (X좌표 차이)]:** 측면 감지 로직을 양쪽 어깨의 **수평(X) 좌표 차이**(`shoulder_x_diff`)가 특정 임계값(`SIDE_VIEW_X_DIFF_THRESHOLD`)보다 *작은지* 여부로 변경.
    *   **결과:** 측면 감지 자체는 성공 (`Side view detected`).
    *   **새로운 문제점:**
        1.  처음 서 있는 상태(`KneeAngle` ≈ 177도)에서 상체-수직 각도(`torso_vertical_angle` ≈ 2도)가 임계값(60도)보다 작다는 조건(`torso_vertical_angle < LEAN_ANGLE_THRESHOLD`)이 잘못 해석되어 "상체를 좀 더 세우세요" 피드백 발생.
        2.  스쿼트 후 올라오는 동작 중(`stage`가 아직 'DOWN')에도 깊이 부족 조건을 만족하여 "더 깊이 앉으세요" 피드백 지속 발생.
*   **[v4 - 피드백 조건 및 시점 개선]:**
    *   **상체 숙임:** 조건식을 `torso_vertical_angle > LEAN_ANGLE_THRESHOLD` (수직 대비 특정 각도 이상 기울어짐)로 수정. 완전히 선 자세(`knee_angle >= UP_POSE_CHECK_ANGLE_THRESHOLD`)에서는 해당 검사 생략.
    *   **깊이 부족:** 검사 시점을 `stage == 'DOWN'` 이면서 동시에 최저점 부근(`knee_angle < KNEE_BENT_ANGLE + DEPTH_CHECK_EXTRA_ANGLE`)일 때로 제한.
    *   **결과:** 서 있을 때 불필요한 상체 숙임 피드백 및 올라올 때 불필요한 깊이 부족 피드백 문제 해결됨.
*   **[v5 - 피드백 우선순위 적용]:**
    *   **문제점:** 과도한 상체 숙임 오류와 깊이 부족 오류가 동시에 발생할 경우, 두 피드백("상체를 덜 숙이세요", "더 깊이 앉으세요")이 함께 나와 사용자 혼란 유발.
    *   **개선:** '과도한 상체 숙임' 오류(`lean_error_detected == True`)가 감지되면, '깊이 부족' 피드백은 제공하지 않도록 로직 수정 (상체 교정 우선).
*   **[v6 - 모듈화]:** 코드 가독성, 유지보수성, 재사용성 향상을 위해 코드를 여러 파일로 분리 (`utils.py`, `squat_analyzer.py`, `visualization.py`, `main.py`).
*   **[v7 - UI/가독성 개선]:**
    *   **한글 깨짐:** `visualization.py`에서 Pillow 라이브러리를 사용하여 한글 폰트(.ttf)로 텍스트를 그리도록 수정.
    *   **화면 크기:** `main.py`에서 `cv2.imshow()` 이후 `cv2.resizeWindow()` 대신, 프레임 자체를 `cv2.resize()`하여 원본 비율을 유지하며 크기를 조절하도록 수정. 회색 영역 문제 해결.

## 4. 현재 상태 및 다음 단계

*   **현재 상태:**
    *   측면 스쿼트 영상을 입력받아 실시간으로 자세 분석 가능.
    *   주요 오류(깊이 부족, 과도한 상체 숙임, 발뒤꿈치 들림) 감지 및 단계/우선순위를 고려한 피드백 로직 구현됨.
    *   자동 측면 감지 기능 구현됨 (어깨 X좌표 차이 기준).
    *   로깅 기능 및 기본적인 시각화 (랜드마크, 정보, 피드백) 구현됨.
    *   한글 피드백 표시 및 화면 크기 문제 해결됨.
    *   코드 모듈화 완료.
*   **다음 단계 (권장):**
    1.  **데이터 기반 성능 검증:** 다양한 실제 스쿼트 영상(정상, 각종 오류 포함) 데이터를 수집하고 **레이블링**합니다.
    2.  **테스트 자동화:** 레이블링된 데이터를 사용하여 현재 알고리즘의 정확도, 정밀도, 재현율 등을 측정하는 자동화된 테스트 환경을 구축합니다.
    3.  **임계값 튜닝 및 로직 정교화:** 테스트 결과를 바탕으로 각종 임계값(`LEAN_ANGLE_THRESHOLD`, `DEPTH_THRESHOLD_Y_OFFSET` 등)을 미세 조정하고, 상태 전환 로직(`KNEE_STRAIGHT_ANGLE`, `KNEE_BENT_ANGLE`)이나 피드백 발생 조건을 더 정교하게 다듬습니다.
    4.  **실패 사례 분석:** 알고리즘이 잘못 판단하는 경우(False Positive/Negative)를 분석하여 개선 아이디어를 도출합니다.
    5.  **반복적인 개선:** 테스트 -> 분석 -> 개선 과정을 반복하여 알고리즘 완성도를 높입니다.